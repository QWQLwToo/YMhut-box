<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>工具窗口</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css"> <style>
        /* 确保工具内容占满窗口 */
        html, body, #app-body, .secret-window-container, .secret-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .secret-content {
            padding: 0; /* 工具自己来控制内边距 */
        }
    </style>
</head>
<body id="app-body" class="tool-window-body"> <div id="background-layer"></div>
    
    <div class="secret-window-container">
        
        <div class="title-bar" style="border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
             <span id="window-title" style="margin-left: 12px; font-weight: 600; -webkit-app-region: drag; flex-grow: 1;">正在加载工具...</span>
            <div class="window-controls">
                <button id="minimize-btn" class="window-control-btn" title="最小化">
                    <i class="fas fa-window-minimize"></i>
                </button>
                <button id="maximize-btn" class="window-control-btn" title="最大化">
                    <i class="fas fa-window-maximize"></i>
                </button>
                <button id="close-btn" class="window-control-btn" title="关闭">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div id="tool-content-area" class="secret-content" style="flex-grow: 1; min-height: 0;">
            <div class="loading-container">
                <img src="../assets/loading.gif" alt="加载中..." class="loading-gif">
                <p id="tool-loading-text" class="loading-text">正在初始化...</p> 
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import configManager from '../js/configManager.js';
        import uiManager from '../js/uiManager.js';
        import { loadToolFromUrl } from '../js/view-loader.js';
        import i18n from '../js/i18n.js'; // [Req 1] 导入 i18n
        
        // 1. 初始化窗口 (主题, 通知, 窗口控制)
        window.uiManager = uiManager; 
        window.configManager = configManager;
        
        const params = new URLSearchParams(window.location.search);
        const theme = params.get('theme') || 'dark';
        document.body.setAttribute('data-theme', theme);
        
        // --- [Req 1] i18n 初始化 ---
        // 独立窗口必须自己从主进程获取语言包
        async function initializeLanguage() {
            try {
                const langConfig = await window.electronAPI.getLanguageConfig();
                i18n.init(langConfig.pack, langConfig.fallback);
                window.i18n = i18n; // 将 i18n 实例暴露给工具
                
                // [Req 1] 翻译加载文本
                document.getElementById('tool-loading-text').textContent = i18n.t('common.loading.tool');
                
            } catch (e) {
                console.error("无法加载语言配置:", e);
                i18n.init(null, {}); // 至少初始化
                window.i18n = i18n; // 暴露后备
            }
        }
        
        // --- [修改] 启动逻辑 ---
        async function start() {
            // 1. 先加载语言
            await initializeLanguage();
            
            // 2. 绑定窗口控制
            document.getElementById('close-btn').addEventListener('click', () => window.electronAPI.closeCurrentWindow());
            document.getElementById('minimize-btn').addEventListener('click', () => window.electronAPI.secretWindowMinimize());
            document.getElementById('maximize-btn').addEventListener('click', () => window.electronAPI.secretWindowMaximize());

            // 3. 加载工具
            loadToolFromUrl();

            // 4. 窗口焦点追踪
            window.addEventListener('focus', () => document.body.classList.add('window-focused'));
            window.addEventListener('blur', () => document.body.classList.remove('window-focused'));
            document.body.classList.add('window-focused');
        }
        
        start();
        
        // [新增] 添加统一的全局点击监听器，用于关闭所有动态下拉菜单
        // (这修复了 hotboardTool 在独立窗口中无法点击外部关闭的问题)
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.custom-select-options.dynamic-active').forEach(openDropdown => {
                // 检查点击是否在下拉菜单 *或* 其关联的触发器之外
                const wrapperId = openDropdown.id.replace('dd-options-', 'dd-wrapper-');
                const trigger = document.getElementById(wrapperId);
                
                if (openDropdown && !openDropdown.contains(e.target) && trigger && !trigger.contains(e.target)) {
                    openDropdown.classList.remove('dynamic-active');
                }
            });
        }, true); // 使用捕获阶段
        
    </script>
</body>
</html>